/* Copyright 2009 dotless project, http://www.dotlesscss.com
 * 
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 * 
 *     http://www.apache.org/licenses/LICENSE-2.0
 *     
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License. */

using System.Collections.Generic;
using System.Linq;
using dotless.Core.engine.CssNodes;
using dotless.Core.engine.LessNodes;

namespace dotless.Core.engine.Pipeline
{
    public class LessToCssDomConverter : ILessToCssDomConverter
    {
        private CssDocument document; 
        private void BuildElement(ElementBlock elementBlock, ICollection<string> path)
        {
            if (!elementBlock.IsRoot())
            {
                path.Add(elementBlock.Selector.ToCss());
                path.Add(elementBlock.Name);


                //Only add an element to the document when we have reached the end of the path
                if (elementBlock.Properties.Count != 0)
                {
                    var cssProperties = new List<CssProperty>();

                    foreach (var property in elementBlock.Properties)
                        cssProperties.Add(new CssProperty(property.Key, property.Evaluate().ToCss()));

                    //Get path content i.e. "p > a:Hover"
                    var pathContent = string.Join(string.Empty, path.Where(p => !string.IsNullOrEmpty(p)).ToArray());
                    pathContent = pathContent.StartsWith(" ") ? pathContent.Substring(1) : pathContent;
                    document.Elements.Add(new CssElement(pathContent, cssProperties));
                }
            }
            if (elementBlock.Inserts.Count == 0) return;
            foreach (var insert in elementBlock.Inserts)
                document.Elements.Add(new CssElement { InsertContent = insert.ToString() });
        }

        private void BuildCssDocumentImpl(IBlock node, ICollection<string> path)
        {
            if(node.Hide)
                return;

            if (node is ElementBlock)
                BuildElement((ElementBlock) node, path);

            foreach (var nextNode in node.SubBlocks)
                BuildCssDocumentImpl(nextNode, new List<string>(path));
        }

        public CssDocument BuildCssDocument(ElementBlock lessRootElementBlock)
        {
            document = new CssDocument();
            BuildCssDocumentImpl(lessRootElementBlock, new List<string>());
            return document;
        }
    }
}